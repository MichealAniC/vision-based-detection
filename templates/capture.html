{% extends 'index.html' %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card stat-card bg-white overflow-hidden">
                <div class="card-header bg-primary text-white p-4">
                    <h4 class="mb-0"><i class="fas fa-camera-retro me-2"></i>Biometric Registration</h4>
                    <p class="small opacity-75 mb-0">Student ID: {{ student_id }}</p>
                </div>
                <div class="card-body p-4 text-center">
                    <div id="instruction_box" class="alert alert-light border mb-4 py-3">
                        <h5 id="live_instruction" class="mb-0 text-primary fw-bold">Ready to Start?</h5>
                        <p class="small text-muted mb-0 mt-1">Please ensure your face is well-lit and centered.</p>
                    </div>

                    <div class="camera-container mb-4 mx-auto" style="max-width: 500px;">
                        <div class="camera-overlay"></div>
                        <img id="video_feed" src="{{ url_for('video_feed') }}" class="w-100 h-100 d-block" alt="Registration Feed">
                    </div>

                    <div class="px-5">
                        <div class="progress mb-4" style="height: 12px; border-radius: 10px;">
                            <div id="capture_progress" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 0%;"></div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <span id="capture_count" class="badge bg-light text-dark p-2 border">0 / 30 Images</span>
                            <span id="capture_percent" class="fw-bold text-primary">0%</span>
                        </div>

                        <button id="start_capture" class="btn btn-primary btn-lg w-100 py-3 shadow-sm mb-3">
                            <span id="capture_text"><i class="fas fa-play me-2"></i>Initialize Capture Sequence</span>
                            <span id="capture_spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                        </button>
                        
                        <div id="status_msg" class="mt-2 fw-medium"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('start_capture').onclick = function() {
    this.disabled = true;
    document.getElementById('capture_text').innerHTML = '<i class="fas fa-sync fa-spin me-2"></i>Capturing...';
    
    let studentId = "{{ student_id }}";
    let count = 0;
    let max = 30;
    let statusMsg = document.getElementById('status_msg');
    let progressBar = document.getElementById('capture_progress');
    let progressCount = document.getElementById('capture_count');
    let progressPercent = document.getElementById('capture_percent');
    let liveInstruction = document.getElementById('live_instruction');

    const instructions = [
        { start: 0, text: "Look straight into the camera." },
        { start: 8, text: "Tilt your head slightly left." },
        { start: 16, text: "Tilt your head slightly right." },
        { start: 24, text: "Now smile or tilt head up slightly." }
    ];

    async function captureFrame() {
        if (count >= max) {
            document.getElementById('video_feed').src = "";
            fetch('/stop_camera');
            
            liveInstruction.innerText = "Processing Data...";
            statusMsg.innerHTML = '<div class="alert alert-info py-2 mt-3"><i class="fas fa-brain me-2"></i>Generating face embeddings. This may take a moment.</div>';
            
            const trainRes = await fetch('/train');
            const trainData = await trainRes.json();
            
            if (trainData.status === "training_started") {
                liveInstruction.innerText = "Registration Complete!";
                statusMsg.innerHTML = '<div class="alert alert-success py-2 mt-3"><i class="fas fa-check-circle me-2"></i>All set! Redirecting...</div>';
                setTimeout(() => {
                    window.location.href = "/students";
                }, 2000);
            }
            return;
        }

        // Update instructions based on count
        const inst = instructions.find((it, idx) => {
            const next = instructions[idx+1];
            return count >= it.start && (!next || count < next.start);
        });
        if (inst) liveInstruction.innerText = inst.text;

        try {
            const response = await fetch('/save_frame', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({student_id: studentId, count: count})
            });

            if (response.ok) {
                count++;
                let percent = Math.round((count / max) * 100);
                progressBar.style.width = percent + "%";
                progressCount.innerText = `${count} / ${max} Images`;
                progressPercent.innerText = `${percent}%`;
            } else if (response.status === 400) {
                const result = await response.json();
                if (result.status === "duplicate") {
                    statusMsg.innerHTML = `<div class="alert alert-danger py-2 mt-3"><i class="fas fa-exclamation-triangle me-2"></i>${result.message}</div>`;
                    document.getElementById('video_feed').src = "";
                    fetch('/stop_camera');
                    return; 
                }
            }
        } catch (error) {
            console.error("Capture failed", error);
        }

        setTimeout(captureFrame, 200);
    }

    captureFrame();
};
</script>
{% endblock %}

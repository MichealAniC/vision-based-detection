{% extends 'index.html' %}

{% block content %}
<div class="container-fluid py-2">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white py-2 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-camera-retro me-2"></i>Biometric Registration</h5>
                    <span class="badge bg-light text-primary">ID: {{ student_id }}</span>
                </div>
                <div class="card-body p-3">
                    <div class="row g-3">
                        <!-- Left Column: Camera and Progress -->
                        <div class="col-md-7">
                            <div class="camera-container position-relative bg-dark rounded overflow-hidden shadow-sm" style="aspect-ratio: 4/3; max-height: 350px;">
                                <!-- Loading State -->
                                <div id="camera_loading" class="position-absolute top-0 start-0 w-100 h-100 d-flex flex-column align-items-center justify-content-center bg-dark text-white" style="z-index: 5;">
                                    <div class="spinner-border text-primary mb-3" role="status"></div>
                                    <p class="small mb-0">Starting Camera...</p>
                                </div>
                                
                                <!-- Guide Frame Overlay -->
                                <div id="guide_frame" class="position-absolute top-50 start-50 translate-middle border border-2 border-primary rounded-circle opacity-50" style="width: 200px; height: 260px; z-index: 2; pointer-events: none;">
                                    <div class="position-absolute top-0 start-50 translate-middle-x bg-primary text-white px-2 py-1 rounded-bottom small" style="font-size: 10px;">ALIGN FACE HERE</div>
                                </div>

                                <img id="video_feed" src="{{ url_for('video_feed') }}" class="w-100 h-100 object-fit-contain" alt="Registration Feed" onload="document.getElementById('camera_loading').classList.add('d-none');">
                                <div class="position-absolute bottom-0 start-0 w-100 p-2" style="background: rgba(0,0,0,0.5);">
                                    <div class="progress" style="height: 10px;">
                                        <div id="capture_progress" class="progress-bar progress-bar-striped progress-bar-animated bg-success" style="width: 0%;"></div>
                                    </div>
                                    <div class="d-flex justify-content-between text-white small mt-1">
                                        <span id="capture_count">0 / 40 Images</span>
                                        <span id="capture_percent">0%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Instructions and Controls -->
                        <div class="col-md-5 d-flex flex-column">
                            <div id="instruction_box" class="alert alert-info border-0 mb-3 flex-grow-1 d-flex flex-column justify-content-center text-center">
                                <h4 id="live_instruction" class="fw-bold text-primary mb-2">Position Your Face</h4>
                                <p class="small text-muted mb-0">Look straight and ensure good lighting.</p>
                            </div>

                            <div class="mt-auto">
                                <button id="start_capture" class="btn btn-primary btn-lg w-100 py-3 shadow-sm mb-2">
                                    <span id="capture_text"><i class="fas fa-play me-2"></i>Start Capture</span>
                                    <span id="capture_spinner" class="spinner-border spinner-border-sm d-none"></span>
                                </button>
                                <div id="status_msg" class="small fw-medium"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Ensure it fits on smaller screens without scrolling */
    #content { padding-top: 10px !important; }
    .camera-container img { transform: scaleX(-1); } /* Mirror effect for easier positioning */
</style>

<script>
document.getElementById('start_capture').onclick = function() {
    this.disabled = true;
    document.getElementById('capture_text').innerHTML = '<i class="fas fa-sync fa-spin me-2"></i>Capturing...';
    
    let studentId = "{{ student_id }}";
    let count = 0;
    let max = 40; // Increased for better accuracy
    let statusMsg = document.getElementById('status_msg');
    let progressBar = document.getElementById('capture_progress');
    let progressCount = document.getElementById('capture_count');
    let progressPercent = document.getElementById('capture_percent');
    let liveInstruction = document.getElementById('live_instruction');

    const instructions = [
        { start: 0, text: "Look Straight" },
        { start: 10, text: "Turn Slightly Left" },
        { start: 20, text: "Turn Slightly Right" },
        { start: 30, text: "Tilt Up/Down & Smile" }
    ];

    async function captureFrame() {
        if (count >= max) {
            document.getElementById('video_feed').src = "";
            fetch('/stop_camera');
            
            liveInstruction.innerText = "Processing Data...";
            statusMsg.innerHTML = '<div class="alert alert-info p-2 mt-2"><i class="fas fa-brain me-2"></i>Optimizing AI Model...</div>';
            
            const trainRes = await fetch('/train');
            const trainData = await trainRes.json();
            
            if (trainData.status === "training_started") {
                liveInstruction.innerText = "Success!";
                statusMsg.innerHTML = '<div class="alert alert-success p-2 mt-2"><i class="fas fa-check-circle me-2"></i>Registration Complete!</div>';
                setTimeout(() => { window.location.href = "/"; }, 2000);
            }
            return;
        }

        const inst = instructions.find((it, idx) => {
            const next = instructions[idx+1];
            return count >= it.start && (!next || count < next.start);
        });
        if (inst) liveInstruction.innerText = inst.text;

        try {
            const response = await fetch('/save_frame', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({student_id: studentId, count: count})
            });

            if (response.ok) {
                count++;
                let percent = Math.round((count / max) * 100);
                progressBar.style.width = percent + "%";
                progressCount.innerText = `${count} / ${max} Images`;
                progressPercent.innerText = `${percent}%`;
            } else if (response.status === 400) {
                const result = await response.json();
                statusMsg.innerHTML = `<div class="alert alert-danger p-2 mt-2"><i class="fas fa-exclamation-triangle me-2"></i>${result.message}</div>`;
                // If it's a duplicate, we stop
                if (result.status === "duplicate") {
                    document.getElementById('video_feed').src = "";
                    fetch('/stop_camera');
                    return;
                }
            }
        } catch (error) {
            console.error("Capture failed", error);
        }

        setTimeout(captureFrame, 150);
    }

    captureFrame();
};
</script>
{% endblock %}

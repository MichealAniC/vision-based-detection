{% extends 'index.html' %}

{% block content %}
<div class="container-fluid py-2">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white py-2 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-camera-retro me-2"></i>Biometric Registration</h5>
                    <span class="badge bg-light text-primary">ID: {{ student_id }}</span>
                </div>
                <div class="card-body p-3">
                    <div class="row g-3">
                        <!-- Left Column: Camera and Progress -->
                        <div class="col-md-7">
                            <div class="camera-container position-relative bg-dark rounded overflow-hidden shadow-sm" style="aspect-ratio: 4/3; max-height: 350px;">
                                <!-- Loading State -->
                                <div id="camera_loading" class="position-absolute top-0 start-0 w-100 h-100 d-flex flex-column align-items-center justify-content-center bg-dark text-white" style="z-index: 5;">
                                    <div class="spinner-border text-primary mb-3" role="status"></div>
                                    <p class="small mb-0">Requesting Camera Access...</p>
                                    <p class="small text-muted mt-2">Please allow camera permission when prompted</p>
                                </div>
                                
                                <!-- Guide Frame Overlay REMOVED -->
                                <canvas id="overlay_canvas" class="position-absolute top-0 start-0 w-100 h-100" style="z-index: 3; pointer-events: none;"></canvas>

                                <video id="video_feed" class="w-100 h-100 object-fit-contain" autoplay muted playsinline style="background: #000;"></video>
                                <div class="position-absolute bottom-0 start-0 w-100 p-2" style="background: rgba(0,0,0,0.5);">
                                    <div class="progress" style="height: 10px;">
                                        <div id="capture_progress" class="progress-bar progress-bar-striped progress-bar-animated bg-success" style="width: 0%;"></div>
                                    </div>
                                    <div class="d-flex justify-content-between text-white small mt-1">
                                        <span id="capture_count">0 / 40 Images</span>
                                        <span id="capture_percent">0%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Instructions and Controls -->
                        <div class="col-md-5 d-flex flex-column">
                            <div id="instruction_box" class="alert alert-info border-0 mb-3 flex-grow-1 d-flex flex-column justify-content-center text-center">
                                <h4 id="live_instruction" class="fw-bold text-primary mb-2">Position Your Face</h4>
                                <p class="small text-muted mb-0">Look straight and ensure good lighting.</p>
                            </div>

                            <div class="mt-auto">
                                <button id="start_capture" class="btn btn-primary btn-lg w-100 py-3 shadow-sm mb-2">
                                    <span id="capture_text"><i class="fas fa-play me-2"></i>Start Capture</span>
                                    <span id="capture_spinner" class="spinner-border spinner-border-sm d-none"></span>
                                </button>
                                <div id="status_msg" class="small fw-medium"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Ensure it fits on smaller screens without scrolling */
    #content { padding-top: 10px !important; }
    #video_feed { transform: scaleX(-1); } /* Mirror effect for easier positioning */
</style>

<script>
let stream = null;
let capturing = false;

// Function to request camera permission and start video stream
async function startCamera() {
    const videoElement = document.getElementById('video_feed');
    const canvasElement = document.getElementById('overlay_canvas');
    const loadingElement = document.getElementById('camera_loading');
    const startButton = document.getElementById('start_capture');
    const loadingText = loadingElement.querySelector('p');
    
    try {
        console.log('Requesting camera access...');
        loadingText.textContent = 'Requesting Camera Access...';
        
        // First check if media devices are available
        if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
            throw new Error('Media devices not supported');
        }
        
        // Enumerate devices to check for cameras
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        
        if (videoDevices.length === 0) {
            throw new Error('NotFoundError');
        }
        
        console.log(`Found ${videoDevices.length} camera(s)`);
        loadingText.textContent = 'Accessing Camera...';
        
        // Try different constraints if the first one fails
        const constraintsList = [
            { video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: 'user' }, audio: false },
            { video: { width: { max: 640 }, height: { max: 480 }, facingMode: 'user' }, audio: false },
            { video: { facingMode: 'user' }, audio: false },
            { video: true, audio: false }
        ];
        
        let streamSuccess = false;
        
        for (let i = 0; i < constraintsList.length; i++) {
            try {
                console.log(`Trying constraint set ${i + 1}`);
                stream = await navigator.mediaDevices.getUserMedia(constraintsList[i]);
                streamSuccess = true;
                break;
            } catch (constraintError) {
                console.log(`Constraint set ${i + 1} failed:`, constraintError.name);
                if (i === constraintsList.length - 1) {
                    throw constraintError;
                }
            }
        }
        
        if (!streamSuccess) {
            throw new Error('Failed to get camera stream');
        }
        
        console.log('Camera access granted');
        loadingText.textContent = 'Starting Camera...';
        
        // Set the video stream as source
        videoElement.srcObject = stream;
        
        // Wait for video to load metadata
        await new Promise((resolve, reject) => {
            videoElement.onloadedmetadata = resolve;
            videoElement.onerror = reject;
            setTimeout(() => reject(new Error('Timeout')), 5000);
        });
        
        // Play the video
        await videoElement.play();
        
        console.log('Camera started successfully');
        loadingElement.classList.add('d-none');
        startButton.disabled = false;
        
        // Match canvas size to video
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;

    } catch (error) {
        console.error('Camera error:', error);
        startButton.disabled = true;
        showError(getErrorMessage(error));
    }
}

function getErrorMessage(error) {
    switch (error.name) {
        case 'NotAllowedError':
            return 'Camera access denied. Please click the camera icon in your browser\'s address bar to allow access, then refresh the page.';
        case 'NotFoundError':
            return 'No camera found. Please connect a camera and refresh the page.';
        case 'NotReadableError':
            return 'Camera is being used by another application. Please close other apps using the camera.';
        case 'OverconstrainedError':
            return 'Your camera doesn\'t meet the required specifications.';
        case 'SecurityError':
            return 'Camera access is blocked. Please ensure you\'re using HTTPS and refresh the page.';
        default:
            return 'Unable to access camera. Please check your browser settings and refresh the page.';
    }
}

function showError(message) {
    const loadingElement = document.getElementById('camera_loading');
    loadingElement.classList.add('d-none');
    
    const errorDiv = document.createElement('div');
    errorDiv.id = 'camera_error';
    errorDiv.className = 'position-absolute top-0 start-0 w-100 h-100 d-flex flex-column align-items-center justify-content-center bg-dark text-white text-center p-3';
    errorDiv.style.zIndex = '10';
    errorDiv.innerHTML = `
        <i class="fas fa-video-slash fa-3x mb-3 text-danger"></i>
        <h5 class="mb-3">Camera Access Required</h5>
        <p class="mb-4">${message}</p>
        <div class="d-grid gap-2 col-8 mx-auto">
            <button class="btn btn-primary" onclick="retryCamera()">
                <i class="fas fa-redo me-2"></i>Retry Camera Access
            </button>
            <button class="btn btn-outline-light" onclick="location.reload()">
                <i class="fas fa-sync me-2"></i>Refresh Page
            </button>
        </div>
        <div class="mt-4 small text-muted">
            <p class="mb-2"><strong>Troubleshooting Tips:</strong></p>
            <ul class="text-start" style="max-width: 350px;">
                <li>Click the camera icon ðŸ”’ in your browser's address bar</li>
                <li>Ensure you're using <strong>HTTPS</strong> (not HTTP)</li>
                <li>Check that no other apps are using your camera</li>
                <li>Try a different browser (Chrome, Firefox, Edge recommended)</li>
                <li>If on mobile, check app permissions in device settings</li>
            </ul>
        </div>
    `;
    document.querySelector('.camera-container').appendChild(errorDiv);
}

// New retry function
async function retryCamera() {
    // Remove existing error div
    const errorDiv = document.getElementById('camera_error');
    if (errorDiv) {
        errorDiv.remove();
    }
    
    // Show loading again
    const loadingElement = document.getElementById('camera_loading');
    loadingElement.classList.remove('d-none');
    
    // Reset stream
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
    
    // Try to start camera again
    await startCamera();
}

// Stop camera when page unloads
window.addEventListener('beforeunload', () => {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
});

// Initialize camera when page loads
document.addEventListener('DOMContentLoaded', () => {
    // Disable start button initially
    document.getElementById('start_capture').disabled = true;
    
    // Check if browser supports media devices
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        console.log('Browser supports camera access');
        startCamera();
    } else {
        console.log('Browser does not support camera access');
        document.getElementById('start_capture').disabled = true;
        showError('Your browser doesn\'t support camera access. Please use a modern browser like Chrome, Firefox, or Edge.');
    }
});

document.getElementById('start_capture').onclick = function() {
    if (capturing) return;
    
    capturing = true;
    this.disabled = true;
    document.getElementById('capture_text').innerHTML = '<i class="fas fa-sync fa-spin me-2"></i>Capturing...';
    
    let studentId = "{{ student_id }}";
    let count = 0;
    let max = 40; // Increased for better accuracy
    let statusMsg = document.getElementById('status_msg');
    let progressBar = document.getElementById('capture_progress');
    let progressCount = document.getElementById('capture_count');
    let progressPercent = document.getElementById('capture_percent');
    let liveInstruction = document.getElementById('live_instruction');

    const instructions = [
        { start: 0, text: "Look Straight" },
        { start: 10, text: "Turn Slightly Left" },
        { start: 20, text: "Turn Slightly Right" },
        { start: 30, text: "Tilt Up/Down & Smile" }
    ];

    async function captureFrame() {
        if (count >= max || !capturing) {
            // Stop camera
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            document.getElementById('video_feed').srcObject = null;
            // fetch('/stop_camera'); // No longer needed
            
            liveInstruction.innerText = "Processing Data...";
            statusMsg.innerHTML = '<div class="alert alert-info p-2 mt-2"><i class="fas fa-brain me-2"></i>Optimizing AI Model...</div>';
            
            try {
                const trainRes = await fetch('/train');
                const trainData = await trainRes.json();
                
                if (trainData.status === "training_started") {
                    liveInstruction.innerText = "Success!";
                    statusMsg.innerHTML = '<div class="alert alert-success p-2 mt-2"><i class="fas fa-check-circle me-2"></i>Registration Complete!</div>';
                    setTimeout(() => { window.location.href = "/"; }, 2000);
                } else {
                    throw new Error(trainData.message || "Training failed");
                }
            } catch (err) {
                console.error("Training error:", err);
                liveInstruction.innerText = "Registration Failed";
                statusMsg.innerHTML = `<div class="alert alert-danger p-2 mt-2"><i class="fas fa-times-circle me-2"></i>Error: ${err.message}. Please try again.</div>`;
                // Re-enable button to allow retry
                document.getElementById('start_capture').disabled = false;
                document.getElementById('capture_text').innerText = "Retry Registration";
                capturing = false;
                count = 0; // Reset count for retry
                document.getElementById('capture_progress').style.width = "0%";
                document.getElementById('capture_count').innerText = "0 / " + max + " Images";
            }
            return;
        }

        // Capture frame using Canvas
        const video = document.getElementById('video_feed');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = canvas.toDataURL('image/jpeg', 0.8);
        
        // Get overlay canvas for drawing Green Box
        const overlayCanvas = document.getElementById('overlay_canvas');
        const overlayCtx = overlayCanvas.getContext('2d');
        
        // Ensure overlay canvas matches video dimensions
        if (overlayCanvas.width !== video.videoWidth) {
             overlayCanvas.width = video.videoWidth;
             overlayCanvas.height = video.videoHeight;
        }

        try {
            const response = await fetch('/save_capture', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    image: imageData,
                    student_id: studentId
                })
            });

            const data = await response.json();
            
            // Clear previous drawings
            overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            
            // Mirror for user experience
            overlayCtx.save();
            overlayCtx.translate(overlayCanvas.width, 0);
            overlayCtx.scale(-1, 1);

            if (data.status === 'success') {
                count = data.count; // Use server count
                let percent = Math.min(100, Math.round((count / max) * 100));
                
                progressBar.style.width = percent + "%";
                progressCount.innerText = count + " / " + max + " Images";
                progressPercent.innerText = percent + "%";
                
                // Clear any previous error messages
                statusMsg.innerHTML = '';
                
                // Draw Green Box
                if (data.box) {
                    const [x, y, w, h] = data.box;
                    
                    // Draw Box
                    overlayCtx.strokeStyle = '#00FF00';
                    overlayCtx.lineWidth = 3;
                    overlayCtx.strokeRect(x, y, w, h);
                    
                    // Draw Tag
                    overlayCtx.font = 'bold 16px Arial';
                    overlayCtx.fillStyle = '#00FF00';
                    const text = "Detected";
                    const textWidth = overlayCtx.measureText(text).width;
                    overlayCtx.fillRect(x, y - 25, textWidth + 10, 25);
                    overlayCtx.fillStyle = '#000000';
                    overlayCtx.fillText(text, x + 5, y - 7);
                }
                
                // Update instructions
                let step = Math.floor(count / 10);
                if (step < instructions.length) {
                    liveInstruction.innerText = instructions[step].text;
                }
                
                // Continue capturing if not done
                if (count < max) {
                    setTimeout(captureFrame, 200); // 200ms delay between frames
                } else {
                    captureFrame(); // Trigger finish
                }
                
                overlayCtx.restore(); // Restore context
                
            } else if (data.status === 'retry') {
                overlayCtx.restore(); // Restore context even on retry
                // Face not detected or invalid, but we keep trying
                console.log("Retry:", data.message);
                statusMsg.innerHTML = `<div class="text-warning small"><i class="fas fa-exclamation-circle me-1"></i>${data.message}</div>`;
                if (capturing) {
                    setTimeout(captureFrame, 100); // Retry faster
                }
            } else {
                console.error("Save failed:", data.message);
                capturing = false;
                document.getElementById('start_capture').disabled = false;
                document.getElementById('capture_text').innerText = "Retry Capture";
                statusMsg.innerHTML = `<div class="text-danger small">${data.message}</div>`;
            }
        } catch (err) {
            console.error("Error sending frame:", err);
            capturing = false;
        }
    }

    captureFrame();
};
</script>
{% endblock %}